{% extends 'menu_layout.html' %}

{% block content %}
<div class="account">

        <h1>Account Details</h1>

    <div class="account-details">
        <b><p class="account-heading">Username:</p></b>
        <!--SAJ: Update to feed live data to <p> class needs: a) to be empty string can't be null b) have id-->
        <p class="account-info" id="username" >" "</p> 
    </div>
    <div class="account-details">
        <b><p class="account-heading">First Name:</p></b>
        <!--SAJ: Update to feed live data to <p> class needs: a) to be empty string can't be null b) have id-->
        <p class="account-info" id="firstname">" "</p>
    </div>
    <div class="account-details">
        <b><p class="account-heading">Last Name:</p>
        <!--SAJ: Update to feed live data to <p> class needs: a) to be empty string can't be null b) have id-->
        </b>        <p class="account-info" id="lastname">" "</p>
    </div>
    <div class="account-details">
        <b><p class="account-heading">Email:</p>
        <!--SAJ: Update to feed live data to <p> class needs: a) to be empty string can't be null b) have id-->
        </b>    <p class="account-info" id="useremail">" "</p>
    </div>
    <div class="account-details">
        <b><p class="account-heading">Password:</p>
        </b>       <p class="account-info">********</p>
    </div>

    <!-- SAJ This can be moved and be its own page, I needed this here so I could test Change Password feature.  If I can't get it to work, We can delete the entire thing.  Needs Styling-->
    <form class="updatepassword" name='updatepsw' onsubmit="return checkPassword()" action="{{url_for('changepassword')}}" method="POST">       
        <label for="psw" hidden id="tpsw" ><b>Password:</b><br></label>
        <input type="password" hidden id="vpsw" placeholder="Enter Password" name="psw" minlength="8" required><br><br>
        <label for="repsw"  hidden id="trepsw"><b>Re-enter Password:</b><br></label>
        <input type="password" hidden id="vrepsw" placeholder="Re-enter Password" name="repsw" minlength="8" required>
        <span hidden id='notsame' style='font-size: 20px; color:red; padding: 5px'>Passwords do not match</span><br><br>
        <label for="blanklines"  hidden id="lblank"><b></b><br><br></label>
        {{msg}}
    </form>
    
    <!-- this button should change p tags with class="account-info" to input fields so the user can update their information in the database -->
    <div class="account-buttons">
        <!---SAJ- Added a savepassword button, added id so I could turn them off and on -->
        <button type ="button" onclick="savepassword()" id="btn_save_change">Save New Password</button>        
        <button type ="button" onclick="changepassword()" id="btn_change_psw">Change Password</button>
        <button id='month' onclick='viewCh(this)' id="btn_goback">Back to calendar</button>
    </div> <!-- /account-buttons -->
</div>
{% endblock content %}

{% block script %}
<!-- Most of this can be deleted if I do not get the Change Password to work.  I placed the javascript in here because I couldn't get it to work otherwise.  -->
<script src="{{url_for('static', filename = 'monthly.js')}}"></script>
<script src="{{url_for('static', filename = 'script.js')}}"></script>
<script>

    var valid_password

    //Feed the information displayed on the page with the user information for the current user
    user={{user|tojson}} ;

    document.getElementsByClassName("account-details").innerHTML=user;
    document.getElementById("username").innerHTML=user.username
    document.getElementById("firstname").innerHTML=user.fname
    document.getElementById("lastname").innerHTML=user.lname
    document.getElementById("useremail").innerHTML=user.email


    hideChangePwdForm()


    function hideChangePwdForm(){
        //Hide the form to change the password 
        $("#tpsw").hide("slow").css({"font-family": "Arial, Helvetica, sans-serif", "font-size": "20px"})
        $("#vpsw").hide("slow").css({"font-family": "Arial, Helvetica, sans-serif", "font-size": "20px"})
        $("#trepsw").hide("slow").css({"font-family": "Arial, Helvetica, sans-serif", "font-size": "20px", "Padding": "15px"})
        $("#vrepsw").hide("slow").css({"font-family": "Arial, Helvetica, sans-serif", "font-size": "20px", "Padding": "15px"})
        $("#lblank").hide("slow").css({"font-family": "Arial, Helvetica, sans-serif", "font-size": "20px", "Padding": "15px"}).append("<br><br><br>") 
        //Also hide all the buttons associated with selecting changing password
        $("#btn_save_change").hide()
    }


    function changepassword(){ 

        prepareChangePwdForm()
        showChangePwdForm()
        //check if password was typed and retyped correctly
        $(document).ready(function(){
            $('[name=repsw]').blur(function(){checkEqu(this)})
        })
    }

    function prepareChangePwdForm(){
        //Hide these items because user is changing the password
        ///toggleOffOn(document.getElementById("userpassword"))
        ///toggleOffOn(document.getElementById("titlepassword")
        $("#userpassword").hide()
        $("#titlepassword").hide()
        //Hide these buttons because user is changing the password
        $("#btn_goback").hide()
        $("#btn_change_psw").hide()  
    }

    function showChangePwdForm(){
        //Show change of password labels and input
        $("#tpsw").show()
        $("#vpsw").show()
        $("#trepsw").show()
        $("#vrepsw").show()
        //Show the save change button
        $("#btn_save_change").show()
    }

    function toggleOffOn(elementIdName){
        if (elementIdName.style.display == "none"){
            elementIdName.style.display = "block";
        }else {
            elementIdName.style.display = "none";
        }
    }

    function checkEqu(e){
        var m= document.getElementsByName('psw')[0].value
        valid_password = (e.value == m)
        if(e.value != m){$('#notsame').show("slow") }
        else{$('#notsame').hide("slow")} 

        if (!(valid_password)) {
            return false;
        }else{
            return true;
        }
    }

    function savepassword(){
        newpassword=$("#vpsw").val();
        var send= {"user":user, "psw":document.getElementById("vpsw").value}
        payload=JSON.stringify(send);
        $.post('/changepassword',{'id': payload},function(data){($('#btn_save_change').prop('disabled',false))}, 'json')
        hideChangePwdForm()
    }

</script>
{% endblock script %}